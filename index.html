<html class="droparea" lang="ru">
<head>
    <title>Bioton change settings</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
    <style type="text/css">
        .settings_block {
            margin: 1%;
            margin-top: 2%;
            
        }
        
        .settings_elem {
            border: 1px solid;
            border-radius: 5px;
            padding: 1%;
            margin-bottom: 1%;
        }
        
        .settings_elem h2 {
            font-weight: bold;
        }
        
        .settings_input {
            width: 100%;
        }
        
        .switch {
          position: relative;
          display: inline-block;
          width: 60px;
          height: 34px;
        }
        
        /* Hide default HTML checkbox */
        .switch input {
          opacity: 0;
          width: 0;
          height: 0;
        }
        
        /* The slider */
        .slider {
          position: absolute;
          cursor: pointer;
          top: 0;
          left: 0;
          right: 0;
          bottom: 0;
          background-color: #ccc;
          -webkit-transition: .4s;
          transition: .4s;
        }
        
        .slider:before {
          position: absolute;
          content: "";
          height: 26px;
          width: 26px;
          left: 4px;
          bottom: 4px;
          background-color: white;
          -webkit-transition: .4s;
          transition: .4s;
        }
        
        input:checked + .slider {
          background-color: #2196F3;
        }
        
        input:focus + .slider {
          box-shadow: 0 0 1px #2196F3;
        }
        
        input:checked + .slider:before {
          -webkit-transform: translateX(26px);
          -ms-transform: translateX(26px);
          transform: translateX(26px);
        }
        
        /* Rounded sliders */
        .slider.round {
          border-radius: 34px;
        }
        
        .slider.round:before {
          border-radius: 50%;
        }
        
        

        @media (max-width: 300px) {
            body {
                font-size: 200%;
            }
        }
    </style>
</head>
<body class="m-2">
    <h1 class="text-center">Bioton change settings</h1>
    <div class="form-floating mb-3">
      <select id="device" class="form-control"></select>
      <label for="device">Select device</label>
    </div>
    <div class="settings_block text-center">
        <div class="settings_elem">
            <h2>BPM</h2>
            <div class="container">
                <div class="col w-100">
                    <div class="row">
                        <label for="bpm_input_text">Plant Bpm</label>
                        <input id="bpm_input_text" class="form-control" type="value" value="60" min="10" max="1000" oninput="this.nextElementSibling.value = this.value"/>
                        <input type="range" class="settings_input" oninput="this.previousElementSibling.value = this.value" value="60" id="bpm_input" name="BPM" min="10" max="1000" />
                    </div>
                    <div class="row">
                        <label for="bpm_plant_note_off">Note Off Percent</label>
                        <input class="form-control" type="value" id="bpm_plant_note_off" value="100" min="1" max="100" oninput="this.nextElementSibling.value = this.value"/>
                        <input type="range" class="settings_input" oninput="this.previousElementSibling.value = this.value" value="100" id="bpm_plant_note_off_input" name="BPM" min="1" max="100" />
                    </div>
                    <div class="row">
                        <label for="bpm_light_input_text">Light Bpm</label>
                        <input class="form-control" type="value" id="bpm_light_input_text" value="4" min="1" max="30" oninput="this.nextElementSibling.value = this.value"/>
                        <input type="range" class="settings_input" oninput="this.previousElementSibling.value = this.value" value="4" id="bpm_light_input" name="BPM" min="1" max="30" />
                    </div>
                </div>
            </div>
        </div>
        <div class="settings_elem">
            <h2>Sensitivity (fib)</h2>
            <div class="container">
                <div class="col w-100">
                    <div class="row">
                        <label for="fib_pow_input">Note Distance</label>
                        <input class="form-control" type="value" id="fib_pow_input"  value="50" min="0" max="100" oninput="this.nextElementSibling.value = this.value"/>
                        <input type="range" class="settings_input" value="50" min="0" max="100" oninput="this.previousElementSibling.value = this.value"/>
                    </div>
                    <div class="row">
                        <label for="fib_pow_input">First Value</label>
                        <input class="form-control" type="value" id="fib_first_input" value="10" min="0" max="100" oninput="this.nextElementSibling.value = this.value"/>
                        <input type="range" class="settings_input" value="0.1" step="1" min="0" max="100" oninput="this.previousElementSibling.value = this.value"/>
                    </div>
                </div>
            </div>
        </div>
        <div class="settings_elem">
            <h2>Smoothness</h2>
            <div class="container">
                <div class="col w-100">
                    <div class="row">
                        <input class="form-control" type="value" id="smooth_input" value="0" min="0" max="99" oninput="this.nextElementSibling.value = this.value"/>
                        <input type="range" class="settings_input" value="0" min="0" max="99" oninput="this.previousElementSibling.value = this.value"/>
                    </div>
                </div>
            </div>
        </div>
        <div class="settings_elem">
            <h2>Scales</h2>
            <div class="container">
                <div class="col w-100">
                    <div class="row">
                        <select id="scale" class="form-control"></select>
                    </div>
                </div>
            </div>
        </div>
        <div class="settings_elem">
            <h2>Velocity</h2>
            <div class="container">
                <div class="col w-100">
                    <div class="row align-items-center">
                        <div class="col-9">
                            <label for="fib_pow_input">Plant Velocity</label>
                            <input class="form-control" type="value" id="vel_plant_input"  value="127" min="0" max="127" oninput="this.nextElementSibling.value = this.value"/>
                            <input type="range" class="settings_input" value="127" min="0" max="127" oninput="this.previousElementSibling.value = this.value"/>
                        </div>
                        <div class="col-3 ">
                            <label class="switch">
                                <input id="vel_plant_checkbox" type="checkbox" checked>
                                <span class="slider round"></span>
                            </label>
                        </div>
                    </div>
                    <div class="row align-items-center">
                        <div class="col-9">
                            <label for="fib_pow_input">Light Velocity</label>
                            <input class="form-control" type="value" id="vel_light_input" value="127" min="0" max="127" oninput="this.nextElementSibling.value = this.value"/>
                            <input type="range" class="settings_input" value="127" min="0" max="127" oninput="this.previousElementSibling.value = this.value"/>
                        </div>
                        <div class="col-3 ">
                            <label class="switch">
                                <input id="vel_light_checkbox" type="checkbox" checked>
                                <span class="slider round"></span>
                            </label>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="settings_elem">
            <h2>Randomness</h2>
            <div class="container">
                <div class="col w-100">
                    <label class="switch">
                        <input id="randomness_input" type="checkbox" checked>
                        <span class="slider round"></span>
                    </label>
                </div>
            </div>
        </div>
        <div class="settings_elem">
            <h2>Same Note</h2>
            <div class="container">
                <div class="col w-100">
                    <input class="form-control" type="value" id="same_note_input" value="0" min="0" max="10" oninput="this.nextElementSibling.value = this.value"/>
                    <input type="range" class="settings_input" value="0" min="0" max="10" oninput="this.previousElementSibling.value = this.value"/>
                </div>
            </div>
        </div>
        <button id="submit" class="btn btn-primary mb-1" style="width: 70%">Send</button>
        <button id="default_submit" class="btn btn-primary" style="width: 70%">Return default</button>
    </div>
    
    </body>
</html>

<script>

let midiIn = [];
let midiOut = [];
let notesOn = new Map(); 

const Scales = ["Major", "Minor", "Chrom", "Dorian", "Mixolydian", "Lydian", "Wholetone", "Minblues", "Minpen", "Majpen", "Diminished"];
let scale = document.getElementById("scale")
for (let i = 0; i < Scales.length; i++) {
    let newOption = new Option(Scales[i], i.toString());
    scale.add(newOption);
}


function loadLastValues() {
    if (!localStorage.getItem("bpm_input")) {
        returnDefault();
    } 

    document.getElementById("bpm_input").value = localStorage.getItem("bpm_input")
    document.getElementById("bpm_input_text").value = localStorage.getItem("bpm_input")

    document.getElementById("bpm_plant_note_off_input").value = localStorage.getItem("bpm_plant_note_off_input")
    document.getElementById("bpm_plant_note_off_input").previousElementSibling.value = localStorage.getItem("bpm_plant_note_off_input")

    document.getElementById("bpm_light_input").value = localStorage.getItem("bpm_light_input")
    document.getElementById("bpm_light_input").previousElementSibling.value = localStorage.getItem("bpm_light_input")

    document.getElementById("fib_pow_input").value = localStorage.getItem("fib_pow_input")
    document.getElementById("fib_pow_input").previousElementSibling.value = localStorage.getItem("fib_pow_input")

    document.getElementById("fib_first_input").value = localStorage.getItem("fib_first_input")
    document.getElementById("fib_first_input").previousElementSibling.value = localStorage.getItem("fib_first_input")

    document.getElementById("smooth_input").value = localStorage.getItem("smooth_input");
    document.getElementById("smooth_input").nextElementSibling.value = localStorage.getItem("smooth_input");

    scale.value = localStorage.getItem("scale_value")

    document.getElementById("vel_plant_input").value = localStorage.getItem("vel_plant_input")
    document.getElementById("vel_plant_input").nextElementSibling.value = localStorage.getItem("vel_plant_input")

    document.getElementById("vel_light_input").value = localStorage.getItem("vel_light_input")
    document.getElementById("vel_light_input").nextElementSibling.value = localStorage.getItem("vel_light_input")

    document.getElementById("randomness_input").checked = localStorage.getItem("randomness_input") == "true"

    document.getElementById("same_note_input").value = localStorage.getItem("same_note_input")
    document.getElementById("same_note_input").nextElementSibling.value = localStorage.getItem("same_note_input")
}

loadLastValues();

connect();


function connect() {
    navigator.requestMIDIAccess({sysex: true})
  .then(
        (midi) => midiReady(midi),
        (err) => console.log('Something went wrong', err));
}

function midiReady(midi) {
    midi.addEventListener('statechange', (event) => initDevices(event.target));
    initDevices(midi);
}

function initDevices(midi) {

    midiIn = [];
    midiOut = [];

    const inputs = midi.inputs.values();
    for (let input = inputs.next(); input && !input.done; input = inputs.next()) {
        midiIn.push(input.value);
    }

    const outputs = midi.outputs.values();
    for (let output = outputs.next(); output && !output.done; output = outputs.next()) {
        midiOut.push(output.value);
    }


    displayDevices();
}

function displayDevices() {
    let device = document.getElementById("device")
   
    device.innerHTML = "";
    let i = 0;
    for (let output of midiOut) {
        let newOption = new Option(output.name, i.toString());
        i++;
        output.send([]);
        device.add(newOption);
    }

    midiOut[document.getElementById("device").value].send([]);
}

function sleep(milliseconds) {
    const date = Date.now();
    let currentDate = null;
    do {
        currentDate = Date.now();
    } while (currentDate - date < milliseconds);
}

let lastTime = new Date().getTime();
function sendMidiMessage() {
    if (new Date().getTime() - lastTime < 500) {
        return;
    }
    lastTime = new Date().getTime();
    const device = midiOut[document.getElementById("device").value];
    
    let msgOn = [240, 11, 0];
    
    let BPM_value = document.getElementById("bpm_input").value;
    
    for (let i = 1; i < BPM_value / 127; i++) msgOn.push(127);
    msgOn.push(BPM_value % 127);
    msgOn.push(247);
    
    console.log(msgOn);
    device.send(msgOn);
    localStorage.setItem("bpm_input", BPM_value)

    sleep(100);


    msgOn = [240, 11, 10]
    msgOn.push(parseInt(document.getElementById("bpm_plant_note_off_input").value));
    msgOn.push(247);

    console.log(msgOn);
    device.send(msgOn);
    localStorage.setItem("bpm_plant_note_off_input", parseInt(document.getElementById("bpm_plant_note_off_input").value))

    sleep(100);


    msgOn = [240, 11, 7]
    msgOn.push(parseInt(document.getElementById("bpm_light_input").value));
    msgOn.push(247);

    console.log(msgOn);
    device.send(msgOn);
    localStorage.setItem("bpm_light_input", parseInt(document.getElementById("bpm_light_input").value))
    sleep(100);
    
    msgOn = [240, 11, 1]
    msgOn.push(parseInt(document.getElementById("fib_pow_input").value));
    msgOn.push(parseFloat(document.getElementById("fib_first_input").value));
    msgOn.push(247);
    
    console.log(msgOn);
    device.send(msgOn);
    localStorage.setItem("fib_pow_input", parseInt(document.getElementById("fib_pow_input").value))
    localStorage.setItem("fib_first_input", parseInt(document.getElementById("fib_first_input").value))

    sleep(100);
    
    msgOn = [240, 11, 2]
    msgOn.push(parseInt(document.getElementById("smooth_input").value));
    msgOn.push(247);

    console.log(msgOn);
    device.send(msgOn);
    localStorage.setItem("smooth_input", parseInt(document.getElementById("smooth_input").value))

    sleep(100);
    
    msgOn = [240, 11, 3]
    msgOn.push(parseInt(scale.value));
    msgOn.push(247);

    console.log(msgOn);
    device.send(msgOn);
    localStorage.setItem("scale_value", parseInt(scale.value))

    sleep(100);
    
    msgOn = [240, 11, 4, 1]
    msgOn.push(parseInt(document.getElementById("vel_plant_input").value));
    msgOn.push(247);

    console.log(msgOn);
    device.send(msgOn);
    localStorage.setItem("vel_plant_input", parseInt(document.getElementById("vel_plant_input").value))

    sleep(100);
    
    msgOn = [240, 11, 4, 2]
    msgOn.push(parseInt(document.getElementById("vel_light_input").value));
    msgOn.push(247);

    console.log(msgOn);
    device.send(msgOn);
    localStorage.setItem("vel_light_input", parseInt(document.getElementById("vel_light_input").value))

    sleep(100);
    
    msgOn = [240, 11, 8]
    if (document.getElementById("randomness_input").checked) {
        msgOn.push(1);
    }
    else {
        msgOn.push(0);
    }
    msgOn.push(247);

    console.log(msgOn);
    device.send(msgOn);
    localStorage.setItem("randomness_input", document.getElementById("randomness_input").checked)
    sleep(100);
    
    msgOn = [240, 11, 9]
    msgOn.push(parseInt(document.getElementById("same_note_input").value));
    msgOn.push(247);

    console.log(msgOn);
    device.send(msgOn);
    localStorage.setItem("same_note_input", document.getElementById("same_note_input").value)
    sleep(100);
}

function returnDefault() {
    localStorage.setItem("bpm_input", 60)
    localStorage.setItem("bpm_plant_note_off_input", 100)
    localStorage.setItem("bpm_light_input", 4)
    localStorage.setItem("fib_pow_input", 50)
    localStorage.setItem("fib_first_input", 10)
    localStorage.setItem("smooth_input", 0)
    localStorage.setItem("scale_value", 0)
    localStorage.setItem("vel_plant_input", 127)
    localStorage.setItem("vel_light_input", 127)
    localStorage.setItem("randomness_input", "true")
    localStorage.setItem("same_note_input", 0)
    loadLastValues();

    const device = midiOut[document.getElementById("device").value];
    let msgOn = [240, 11, 5, 247];
    console.log(msgOn);
    device.send(msgOn);
}

document.getElementById("submit").addEventListener("click", () => sendMidiMessage());
document.getElementById("default_submit").addEventListener("click", () => returnDefault());

document.addEventListener( 'keyup', event => {
    if( event.code === 'Enter' ) document.getElementById("submit").click()});

document.getElementById('vel_plant_checkbox').addEventListener("click", () => {
    document.getElementById('vel_plant_input').disabled = !document.getElementById('vel_plant_checkbox').checked;
    document.getElementById('vel_plant_input').nextElementSibling.disabled = !document.getElementById('vel_plant_checkbox').checked;
    if (document.getElementById('vel_plant_checkbox').checked) {
        document.getElementById('vel_plant_input').value = 127
        document.getElementById('vel_plant_input').nextElementSibling.value = 127;
    }
    else {
        document.getElementById('vel_plant_input').value = 0
        document.getElementById('vel_plant_input').nextElementSibling.value = 0
    }
})

document.getElementById('vel_light_checkbox').addEventListener("click", () => {
    document.getElementById('vel_light_input').disabled = !document.getElementById('vel_light_checkbox').checked;
    document.getElementById('vel_light_input').nextElementSibling.disabled = !document.getElementById('vel_light_checkbox').checked;
    if (document.getElementById('vel_light_checkbox').checked) {
        document.getElementById('vel_light_input').value = 127
        document.getElementById('vel_light_input').nextElementSibling.value = 127;
    }
    else {
        document.getElementById('vel_light_input').value = 0
        document.getElementById('vel_light_input').nextElementSibling.value = 0
    }
})

const droparea = document.querySelector(".droparea");

droparea.addEventListener("dragover", (e) => {
    e.preventDefault();
})

function readFile(file) {                                                       
    var reader = new FileReader();
    reader.onload = readSuccess;                                            
    function readSuccess(evt) { 
        var field = document.getElementById('main');                        
        field.innerHTML = evt.target.result;                                
    };
    reader.readAsText(file);                                              
} 

droparea.addEventListener("drop", (e) => {
    e.preventDefault();
    
    var file = e.dataTransfer.files[0], reader = new FileReader();
    reader.onload = function(event) {
        console.log(event.target);
        holder.innerText = event.target.result;
    };
    console.log(file);
    reader.readAsText(file);

    // console.log(reader.readAsArrayBuffer(param))
})
</script>